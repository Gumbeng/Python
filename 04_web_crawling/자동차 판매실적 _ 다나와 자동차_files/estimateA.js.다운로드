
/* 차량 가격 계산  */
function calculate_price(chng){
	/*
	1. 기본가격 price.base
	2. 옵션가격 price.itms
	3. 면세/과세 (쌍용제외) price.free
	   하이브리드 (현대/기아 제외) price.free
	4. 판매조건 % 제외(목록만듬), price.DCsum price.DCtax price.DCpay (% 계산시 반영하는 D/C 임시 적립 baseDC)
	   판매조건 % 만.. (기본 + 옵션 + 면세/과세 + baseDC), 금액표시, baseDC 적립) 절사 대우/쌍용 10000 미만 버림, 기아 100 미만 버림, 기타 1 미만 반올림)
	5. 면세/과세 (쌍용)
	   하이브리드 (현대/기아)
	6. 탁송료
	7. 전기차 보조금
	*/
	
	// 1. 기본 가격
	price.base = parseInt(setTrms.pric);	// 기본가격 base
	
	// 2. 선택 품목
	items_total();
	
	// 3. 면세/과세
	price.free = 0;
	
	// 3.0개별소비세 인하
	var brandCode = setTrms.code.substr(0, 3);
	var reductionType = '';
	var customSpecialConsumptionTax = setTrms.ctax;
	
	// 3.1 판단
	// 장애,상용 면세 or LPG 일반인 과세
	if ( (setTrms.ctax > 0 && setFree.pric == 0) || (setTrms.ctax < 0 && setFree.pric == 1) ) {
		// 국산차
		if (Math.abs(setTrms.ctax) < 100) price.taxR = setTrms.ctax * -1.3;
		// 수입차
		else price.taxR = setTrms.ctax;
		
		// H(면세)/GL(과세)
		price.taxK = setFree.grup;
		
		if (setFree.grup == 'H' || setFree.grup == 'C' || setFree.grup == 'T') {
			reductionType = 'F';
		}
		else {
			reductionType = price.taxK;
		}
	// 다자녀 감면
	} else if ( (setTrms.ctax > 0 && setFree.pric == 1 && setFree.grup == 'G' && setFree.enty == 4)) {
		price.taxR = setTrms.ctax * -1.3;
		price.taxK = setFree.grup;
		reductionType = 'M';
	}
	// 전기차 감면
//	else if (setTrms.fuel.indexOf('E') >= 0 && setTrms.dvsn.indexOf("e0") == -1 && setTrms.ctax > 0) {
//		price.taxR = setTrms.ctax * -1.3;
//		price.taxK = "e";
//		
//		reductionType = 'E';
//	}
	// 하이브리드, PHEV 감면
	else if ((setTrms.dvsn.indexOf("h") >= 0 || setTrms.dvsn.indexOf("f") >= 0) && setTrms.ctax > 0) {
		price.taxR = setTrms.ctax * -1.3;
		price.taxK = "h";
		
		reductionType = 'h';
	}
	// 연료전지차 감면
	else if (setTrms.fuel.indexOf("H") >= 0 && setTrms.ctax > 0) {
		price.taxR = setTrms.ctax * -1.3;
		price.taxK = "c";
		
		reductionType = 'H';
	}
	else if (setTrms.ctax == 100.0) {
		price.taxR = setTrms.ctax;
		price.taxK = "";
	}
	else if(setTrms.dvsn.indexOf("d") >= 0 && setTrms.dvsn.indexOf("e0") == -1 && setTrms.ctax > 0) {
		price.taxR = setTrms.ctax * -1.3;
		price.taxK = "e";
		
		reductionType = 'E';		
	}
	// 해당 없음
	else {
		price.taxR = 0;
		price.taxK = "";
	}
	
	// 3.2 계산(면세/과세)
	var alredyCallTermsTotal = 0;
	
	if (price.taxR && price.taxK != 'h' && price.taxK != 'e' && price.taxK != 'c') {
		if (valCode.brnd == 326) {
			// 4. 판매 조건
			terms_total();
			alredyCallTermsTotal = 1;
			
			price.free = tfree_cost(price.base+price.itms+price.DCtax, customSpecialConsumptionTax, reductionType);
		}
		else {
			if (customSpecialConsumptionTax == 100.0) {
				price.free = 0;
			}
			else {
				price.free = tfree_cost(price.base+price.itms, customSpecialConsumptionTax, reductionType);
			}
		}
	}
	else if (price.taxK == 'h' || price.taxK == 'e' || price.taxK == 'c') {
		if (valCode.brnd == 303 || valCode.brnd == 304 || valCode.brnd == 307) {
			// 4. 판매 조건
			terms_total();
			alredyCallTermsTotal = 1;
			
			price.free = tfree_cost(price.base+price.itms+price.DCtax, customSpecialConsumptionTax, reductionType);
		}
		else {
			price.free = tfree_cost(price.base+price.itms, customSpecialConsumptionTax, reductionType);
		}
	}
	// 일반
	else if ( (price.taxR || customSpecialConsumptionTax > 0) && brandCode < 340) {
		price.free = tfree_cost(price.base+price.itms, customSpecialConsumptionTax, reductionType);
	}
	else {
		price.free = 0;
	}
	
	if (alredyCallTermsTotal == 0) {
		// 4. 판매 조건
		terms_total();
	}
	
	// 6. 탁송료	
	codes.trns = $("#eDiv_"+ebox+" .btnTrnsView").attr("conf");	
	price.trns = 0;
	
	if (codes.trns) {
		tmp = codes.trns.split(":");
		price.trns = parseInt(tmp[0]);
		price.trnsSite = tmp[2];
	}
	else {
		price.trns = 0;
		price.trnsSite = 0;
	}
	
	// 7. 전기차 보조금
	if(setTrms.fuel == "E" && $("#Incnt_"+ebox).length > 0) {
		EVIncentiveInfo();
	}
	
	if(infos.incntGov) {
		price.incnt = infos.incntGov;
		
		if(infos.incntLoc) {
			price.incnt += infos.incntLoc;
		}
	} else {
		price.incnt = 0;
	}
	
	// 7. 합계
	price.entry = number_round((price.base+price.itms+price.free+price.DCtax+price.trns)/1.1,1,"round");
	price.total = price.base+price.itms+price.free+price.DCsum+price.trns+price.incnt;
}

/* 가격표 합계 */
function calculate_cost(){
	var Osum = 0;
	var Ocode = "";
	var Oct = 0;
	
	$(".pChkItemList[ebox='"+ebox+"'] input, .iChkItemList[ebox='"+ebox+"'] input").each(function(){
		var code = $(this).attr("code");
		
		if($(this).is(":checked")){
			var tmpVal = dnw_deChar($(this).attr("value")).split("`"); 
			var tmpVal2 = tmpVal[1].split(":");
			
			Osum += parseInt(tmpVal2[0]);
			
			if(Ocode){
				Ocode += ",";
			}
			
			Ocode += code;
			
			Oct++;
		}
	});
	
	// 개별소비세 인하 적용
	var tmp = dnw_deChar($(".priceInfo."+ebox).attr("valCost")).split("`");
	var trimName = '';
	
	if($(".trimsName"+ebox).length > 0) {
		trimsName = $(".trimsName"+ebox).get(0).innerText;
		
	} else {
		var altEbox = ebox;
		var trimNum = altEbox.replace(/[^0-9]/g,'');
		var eboxText = ebox.replace(trimNum, '');
		var targetEbox = eboxText + (trimNum-1);
		
		trimsName = $(".trimsName"+ targetEbox).get(0).innerText;
	}
	
	var isTaxDiscount = $(".priceInfo."+ebox).attr("taxDiscount");
	
	Gsum = Osum + parseInt(tmp[0]);
	
	var brandCode = 0;
	
	if (typeof(setTrms) !== "undefined") {
		brandCode = setTrms.code.substr(0, 3);
	}
	else {
		brandCode = $(".priceInfo."+ebox).attr("brand");
	}
	
	var taxFreeCost = 0;
	var reductionType = tmp[2] + tmp[3];

	var priceApiUrl = apiUrl + '/v1/S/tax/taxCutPrice/?basePriceType=sellingPrice&price='+ Gsum +'&reductionType='+ reductionType +'&code=' + brandCode + '&customSpecialConsumptionTax=' + tmp[1] + '&isDiscount=' + isTaxDiscount;
	
	// 2023-11-22 친환경 차량일 경우에만 금액 차감 하도록 조건 추가
	if(reductionType.indexOf('d') != -1) {
		$.ajax({
			url: priceApiUrl,
			type: 'GET',
			dataType: 'json',
			async: false,
			error: function() {},
			success: function(data) {
				taxFreeCost = data.taxCutPrice * -1;
			}
		});
	}
	
	
	gTxt = '';
	gap = 0;
	
	if ( Math.abs(taxFreeCost) > 0 ) {
		gTxt = number_format(taxFreeCost) + '<br />(감면)';
	}
	
	var setCheck = true;
	if (trimsName.indexOf("장애") >= 0) setCheck = false;
	else if (trimsName.indexOf("렌트") >= 0 || trimsName.indexOf("렌터") >= 0 || trimsName.indexOf("랜트") >= 0 || trimsName.indexOf("랜터") >= 0) setCheck = false;
	else if (trimsName.indexOf("택시") >= 0) setCheck = false;
	
	if(setCheck) {
		Gsum = Gsum + taxFreeCost;
	}
	
	if (Osum || gTxt) {
		number_animate(Gsum,".priceInfo."+ebox+" .last");
	}
	else {
		number_animate(Gsum,".priceInfo."+ebox+" .last");
	}
	
	if (gTxt) {
		$(".priceInfo."+ebox+" .gaps").html(gTxt);
	}
	else {
		$(".priceInfo."+ebox+" .gaps").text("");
	}
	
	if (Osum > 0) {
		$(".priceInfo."+ebox+" .itms").text("+ " + number_format(Osum));
		$(".priceInfo."+ebox+" .itmsTitle").removeClass("hide")
	}
	else if (Osum < 0) {
		$(".priceInfo."+ebox+" .itms").text("- " + number_format(Math.abs(Osum)));
		$(".priceInfo."+ebox+" .itmsTitle").removeClass("hide")
	}
	else {
		$(".priceInfo."+ebox+" .itms").text("");
		$(".priceInfo."+ebox+" .itmsTitle").addClass("hide")
	}
	
	$(".priceInfo."+ebox).attr("itms",Ocode);
}

// 판매조건 합계
function terms_total ()
{
	var Psum = 0;	// 가격할인
	var Csum = 0;	// 인도금할인
	var Tcode = "";
	var Tct = "";
	var Tname = "";
	var Pcent = "";	// % 계산목록..
	var Pbase = 0;	// 기본할인 누적.. 할부에서 지정
	var Ploan = 0;	// 개인/법인 모두 적용되는 조건.. (기본, 이벤트, 재고, 전시차)
	var Plink = 0;
	
	$("#Term_"+ebox+" .eChkTermList input").each(function(){
		var termC = $(this).attr("code");
		var term = termC.substring(0,3);
		var termKd = termC.substring(0,1);
		var tmpVal = dnw_deChar($(this).attr("value")).split("`");
		
		if(termKd=="U"){	// 수동입력
			if(termC.substring(3,4)=="M") var kd = termC.substring(4).replace("_",":");
			else if(termC.substring(3,4)=="S") var kd = "C";
			else var kd = "P";	// 구분 P/A.. B % 계산시 반영 조건
			
			var lk = ""; // 저리할부 연계시 .. F 기록..
			
			if(termC.substring(3,4)=="V") kd += "V";
		}
		else{
			if (valCode.brnd < 340) {
				var tmpSet = setTermB[term].split("`");	
				var kd = tmpSet[1];	// 구분 P/A.. B % 계산시 반영 조건
				var lk = tmpSet[6]; // 저리할부 연계시 .. F 기록..	사용되지 않고 설명 번호와 중복되어 있음 , 코드에서 수정해야 함
			}
			else {
				tmpVal = $(this).attr("value").split("`");
				var kd = "P"; // 가격할인 P : 수입차는 가격할인만 사용중으로 확인(2019.02.12)
				var lk = ""; // 저리할부 연계 X
			}
		}
		
		var ckd = $(this).is(":checked");
		
		//가격
		var vol = tmpVal[0].replace('F', '');
		
		if(vol.indexOf('+') == -1) {
			vol = number_only(vol);
		}		
		
		if(ckd){
			// 현금일때만.. 
			if(vol > 100 && vol.toString().indexOf('+') == -1){
				vol = parseInt(vol);
				
				if(kd.indexOf("P")>=0){	// 가격할인(브랜드) Price
					Psum -= vol;
				}
				else if(kd.indexOf("C")>=0){	// 청구할인(대납) Charge
					Csum -= vol;
				}
				else if(kd.indexOf(":")>=0){	// 복합 :
					tmp = kd.split(":");
					tmp[0] = parseInt(tmp[0]);
					tmp[1] = parseInt(tmp[1]);
					Psum -= vol * tmp[0] / (tmp[0] + tmp[1]);
					Csum -= vol * tmp[1] / (tmp[0] + tmp[1]);
				}
				
				if(kd.indexOf("B")>=0) Pbase -= vol;
				if(lk.indexOf("F")>=0) Plink += vol;	// 금액할인 선택시
				if(termKd=="B" || termKd=="E" || termKd=="S" || termKd=="D") Ploan -= vol;
			}
			else if(vol == 0){
				if(lk.indexOf("F")>=0) Plink += 1;	// 악세사리 선택시
			}
			
			// % 계산 제외..
			if(Tcode){
				Tcode += ",";
				Tname += "!";
			}
			
			Tcode += termC;
			Tct ++;
			Tname += termC + "`" + vol + "`" + tmpVal[1];
		}
		
		//%포함 됐을때
		if(vol > 0 && vol < 100 || vol.toString().indexOf('+') > -1){
			Pcent += "!" + termC + "`" + vol + "`" + kd + "`" + ckd + "`" + lk;
		}
	});
	
	// % 조건 계산..
	if(Pcent){
		var tmpP = Pcent.split("!");
		var tmpCt = tmpP.length;
		
		for(ct = 1; ct < tmpCt ; ct ++ ){
			var tmpVal = tmpP[ct].split("`");
			
			//복합일때
			if(tmpVal[1].indexOf('+') > -1) {
				var tmpArray = tmpVal[1].split('+');
				var vol = 0;
				
				$.each(tmpArray, function(i,v) {
					v = number_only(v);
					
					if(Math.abs(v) > 100) {
						vol += v;
					}
					else {
						vol += (price.base + price.itms + Pbase) * v / 100; // price.base + price.itms + price.free + Pbase -> price.base + price.itms + Pbase
					}
				});
			}
			//단일 %일때
			else {
				var vol = (price.base + price.itms + Pbase) * tmpVal[1] / 100; // price.base + price.itms + price.free + Pbase -> price.base + price.itms + Pbase
			}
			
			if(tmpVal[2].indexOf("V")>=0) vol = vol / 1.1;	// 2013-08-06 기능 추가 취등록세 지원 시 공급가 기준으로 계산.. 벤츠 크라이슬러 등 수입차 일부..
			
			var lk = tmpVal[4];
			var termKd = tmpVal[0].substring(0,1);
			
			if(valCode.brnd==312 || valCode.brnd==316 || valCode.brnd==326 || valCode.brnd>340){	// 대우/쌍용 10000 미만 버림
				vol = number_round(vol,10000,"floor");
			}
			else if(valCode.brnd==307){	// 기아 100 미만 버림
				vol = number_round(vol,100,"floor");
			}
			else{
				vol = number_round(vol,1,"round");
			}
			
			if(tmpVal[3]=="true"){
				if(tmpVal[2].indexOf("P")>=0){	// 가격할인(브랜드) Price
					Psum -= vol;
				}
				else if(tmpVal[2].indexOf("C")>=0){	// 청구할인(대납) Charge
					PriceTermC -= vol;
				}
				else if(tmpVal[2].indexOf(":")>=0){	// 복합 :
					tmp = tmpVal[3].split(":");
					tmp[0] = parseInt(tmp[0]);
					tmp[1] = parseInt(tmp[1]);
					Psum -= vol * tmp[0] / (tmp[0] + tmp[1]);
					Csum -= vol * tmp[1] / (tmp[0] + tmp[1]);
				}
				
				if(tmpVal[2].indexOf("B")>=0) Pbase -= vol;
				if(termKd=="B" || termKd=="E" || termKd=="S" || termKd=="D") Ploan -= vol;
			}
			
			if(0 && emod == 'appView') {
			}
			else {
				if (emod == 'compare') {
					$("#Term_"+ebox+" .eRsltTermPers[code='"+tmpVal[0]+"']").text(number_format(vol));
				}
				else {
					$("#Term_"+ebox+" .eRsltTermPers[code='"+tmpVal[0]+"']").text(number_format(Math.floor(vol/10000)));
				}
			}
			
			Tname = Tname.replace(tmpVal[0]+"`"+tmpVal[1]+"`",tmpVal[0]+"`"+vol+"`");
			
			if(lk.indexOf("F")>=0) Plink += vol;	// % 할인 선택시
		}
	}	
	
	price.DCsum = Psum + Csum;	// 조건 합계
	price.DCtax = Psum;	// 가격 할인분
	price.DCpay = Csum;	// 가격 대납
	
	codes.term = Tcode;	// 조건 코드
	price.termN = Tname;	// 조건 명칭 (코드`가격`명칭 ! ...)
	price.termC = Tct;	// 조건 선택 갯수
	price.DClon = Ploan; // 기본할인, 이벤트 할인 (리스 계산시 사용됨)
}

/* 선택사양 합계 계산 */
function items_total(){
	var Osum = 0;
	var Ocode = "";
	var Oname = "";
	var Oct = 0;
	
	if(0 && emod == 'appView') {
	}
	else {
		iBox = "#Optn_"+ebox+" .eChkItemList";
	}
	
	$(iBox+" input").each(function(){
		var code = $(this).attr("code");
		
		if($(this).is(":checked")){
			var tmpVal = dnw_deChar($(this).attr("value")).split("`"); 
			var tmpVal2 = tmpVal[1].split(":");
			
			// 2015-08-27 개별소비세 인하 자동 반영 기능 추가 5.0 -> 3.5		// 개소세 혜택 적용/종료 선택 기능 추가 2015-11-24
			tmpVal2[0] = parseInt(tmpVal2[0]);
			if(ctaxCalType && (price.ctaxOld=="5.0" || price.ctaxOld=="3.5")){
				gap  = taxChangedPrice(price.ctaxOld,tmpVal2[0]);
				price.spDC += gap;
				if((price.ctaxOld=="5.0" && ctaxCalType=="O") || (price.ctaxOld=="3.5" && ctaxCalType=="X")){
					tmpVal2[0] += gap;
				}
			}
			
			Osum += parseInt(tmpVal2[0]);
			
			if(Ocode){
				Ocode += ",";
				Oname += "!";
			}
			Ocode += code;
			Oname += code + "`" + parseInt(tmpVal2[0]) + "`" + tmpVal[2];
			Oct++;
		}
	});
	
	price.itms = Osum;	// 옵션가격
	codes.itms = Ocode;	// 옵션코드
	price.itmsN = Oname;	// 옵션명칭 (코드`가격`명칭 ! ...)
	price.itmsC = Oct;	// 옵션갯수
}
/* 선택사양 목록 표시 2014-05-11 수정 완료.. */
function items_list(){
	// 수동입력 외 지우기.. //
	if(!mobile) {
		$("#Optn_"+ebox).show();
	}
	
	$("#Optn_"+ebox+" .eChkItemList li").each(function(){
		if($(this).hasClass("blank") || ($(this).attr("code") && $(this).attr("code").substring(0,1)!="U")) {
			$(this).remove();
		}
	});	
	
	//분기 처리
	var check = true;
	
	if(rsltConf[ebox]) {
		var tmpConf = rsltConf[ebox].split("@");
		
		if(tmpConf[0]){
			var regexp =/[a-z|A-Z]*/gi;
			var text2 = tmpConf[0].match(regexp);
			
			if (text2 != null) {
				for (i=0; i < text2.length ; i++) {
					if (text2[i]) {
						check = false;
						break;
					}
				}
			}
		}		
	}

	var optionTypeList = {'undefined':'미지정', '1':'기본옵션/패키지', '2':'튜닝/액세서리'}
	var txt = "";
	var addBtn = "";
	var helpDiv = "";
	var toggleBtn = "";
	var moreBtn = moreOnOff = "";
	var moreCheckIndex = 0;
	var optionDetail = new Array();
	
	if (setTrms.optionDeatil) {
		var temp = setTrms.optionDeatil.split("!");
		
		$.each(temp, function(index, val){
			var temp2 = val.split("`");
			
			if(optionDetail[temp2[0]]) {
				optionDetail[temp2[0]] += '#' + temp2[1];
			}
			else {
				optionDetail[temp2[0]] = temp2[1];				
			}
		});
	}
	
	//옵션 리스트 생성
	if (setTrms.options && check) {
		var tmp = setTrms.options.split("!");
		var trimCode = setTrms.code.substring(12,17);
		var modelCode = setTrms.code.substring(3,7);
		var optionTypeText = '';
		
		if(emod == 'compare') {
			var eChkItemListCnt = $(".eChkItemList").length;
			if(tmp.length > 5) {
				moreOnOff = 'off';
				
				moreBtn = "	<div class='choice-more choice-more--close '>\
						   		<a href='javascript:void(0)' class='choice-more__btn sendGA compareOptionMoreBtn' data-actionlabel='옵션 액세서리 더보기`"+modelCode+"' id='compareOptionMoreBtn_"+eChkItemListCnt+"'><span class='txt'>더보기</span></a>\
					   		</div>";
			}			
		}

		$.each(tmp, function(index, val){
			var optionInfo = val.split("`");
			var optionAddInfo = '';
			var toggleOnOff = 'close';

			if(emod != 'compare') {
				if (optionInfo[4] == '2') {
					if (moreCheckIndex > 2 && moreBtn == '') {
						moreOnOff = 'off';
						
						moreBtn = "<div class='choice-more choice-more--close '>\
										<a href='javascript:void(0)' class='choice-more__btn sendGA' data-actionlabel='옵션 액세서리 더보기`"+modelCode+"'><span class='txt'>더보기</span></a>\
									</div>";
					}
					
					moreCheckIndex++;
				}				
			}
			
			var hideClass = "";
			if(emod == 'compare' && index > 4) {
				hideClass = "style='display:none;'";
			}
			
			//옵션 상세
			var optionDetail = new Array();

			if (setTrms.optionDeatil) {
				var temp = setTrms.optionDeatil.split("!");
				
				$.each(temp, function(index, val){
					var temp2 = val.split("`");
					
					if(optionDetail["O"+temp2[0]]) {
						optionDetail["O"+temp2[0]] += '#' + temp2[1];
					}
					else {
						optionDetail["O"+temp2[0]] = temp2[1];				
					}
				});
			}

			if(emod == 'compare') {
				if(optionDetail["O"+optionInfo[0]]) {
					addBtn = "<button type=\"button\" class=\"optionInfo buttonHelp\" val=\""+ optionInfo[0] +"\"><span class=\"screen_behind\">보기</span></button>";
					
					var detailTemp = optionDetail["O"+optionInfo[0]].split("#");
					var detailTxt = '';
					
					$.each(detailTemp, function(optionDetailKey, optionDetailVal){
						
						optionDetailVal = optionDetailVal.replace("&amp;", "&");
						
						var optionExplainTxt = "";
						var optionPhotoTxt = "";
						var optionDetailVal = optionDetailVal.split(";");
						
						//설명
						if (optionDetailVal[2]) {
							optionExplainTxt = "<div class='explain'>"+ optionDetailVal[2] +"</div>";
						}
						
						//사진
						if (optionDetailVal[3]) {
							optionPhotoTxt = 
								"<div class='photo'>" +
									"<img src='"+ optionDetailVal[3] +"' alt='"+ optionDetailVal[1] +"' onerror='imageError(this, &quot;80_80.gif&quot;)'>" +
								"</div>";
						}
						
						var optionNumber = optionDetailKey + 1;
						
						detailTxt += 
							"<div class='content'>" +
								"<h4 class='title'>"+ optionNumber + ". " + optionDetailVal[1] +"</h4>" +
								optionPhotoTxt +
								optionExplainTxt +
							"</div>";
					});
					
					helpDiv = 
						"<div id='optionKey_"+ optionInfo[0] +"' style='display:none;'>" +
							"<div class='layer__sale-info specDetailSection option'>" +
								"<div class='sub'>" +
									"<h3>"+ optionInfo[1] +"(구성옵션)</h3>" +
								"</div>" +
								detailTxt +
							"</div>" +
						"</div>";
				} 
				else {
					addBtn = "";
					helpDiv = "";
				}
			}
			else {
				if(optionDetail[optionInfo[0]]) {
					addBtn = "<a href='javascript:void(0);' class='sendGA g-btn__info eFincPopup' kind='option' val='"+ optionInfo[0] +"' data-actionlabel='옵션 상세정보`"+trimCode+"'>상세정보 보기</a>";
					
				}
				else {
					addBtn = "";
					helpDiv = "";
				}
				
				if(optionDetail["O"+optionInfo[0]]) {
					
					toggleBtn = "<div class='choice-toggle__btn'><a href='javascript:void(0)' class='btn-toggle "+toggleOnOff+"'><span class='blind'>접기</span></a></div>";
					
					var detailTemp = optionDetail["O"+optionInfo[0]].split("#");
					var detailTxt = '';
					
					$.each(detailTemp, function(optionDetailKey, optionDetailVal){
						var optionExplainTxt = "";
						var optionPhotoTxt = "";
						var optionDetailVal = optionDetailVal.replace('&amp;', '&').split(";");
						
						//설명
						if (optionDetailVal[2]) {
							optionExplainTxt = "<div class='exp'>"+ optionDetailVal[2] +"</div>";
						}
						
						//사진
						if (optionDetailVal[3]) {
							optionPhotoTxt = 
								"<div class='photo'>" +
								"<img src='"+ optionDetailVal[3] +"' alt='"+ optionDetailVal[1] +"' onerror='imageError(this, &quot;80_80.gif&quot;)'>" +
								"</div>";
						}
						
						var optionNumber = optionDetailKey + 1;
						
						detailTxt += 
							"<div class='infodetail__cont'>" +
							"<h4 class='title'>"+ optionNumber + ". " + optionDetailVal[1] +"</h4>" +
							optionPhotoTxt +
							optionExplainTxt +
							"</div>";
					});
					
					helpDiv = "<div class='choice-toggle__cont'>\
									"+detailTxt+"\
									<div class='infodetail__btn'>\
										<label for='popupItem_"+ ebox + optionInfo[0] +"' class='btn-check btn-check--option sendGA' data-actionlabel='옵션 펼쳐보기 내 선택`"+ optionInfo[1] +"'></label>\
									</div>\
									<div class='choice-toggle__close mobOnly'>\
										<a href='javascript:void(0)' class='btn-toggle-close sendGA' data-actionlabel='옵션 펼쳐보기 내 선택`영역 닫기'><span class='txt'>닫기</span></a>\
									</div>\
								</div>"
						
				}
				else {
					addBtn = "";
					helpDiv = "";
					toggleBtn = "";
				}
			}
			
			var value = '';
			
			if(optionInfo[3]) {
				value = dnw_enChar(optionInfo[0]+ "`" +optionInfo[2]+ ":" + optionInfo[3] + "`" + optionInfo[1] + "`" + optionInfo[5]);					
			}
			else {
				value = dnw_enChar(optionInfo[0]+ "`" +optionInfo[2]+ "`" + optionInfo[1] + "`" + optionInfo[5]);					
			}
			
			if(emod == 'compare') {
				txt += "<li code=\""+optionInfo[0]+"\" class=\"\"' "+hideClass+">\n";
				txt += "<input type=\"checkbox\" value=\""+ value +"\" code=\""+optionInfo[0]+"\" id=\"item_"+ebox+optionInfo[0]+"\">\n";
				txt += "<span class=\"title\"><label for=\"item_"+ebox+optionInfo[0]+"\">"+optionInfo[1]+"</label>"+addBtn+"</span>\n";
				txt += "<span class=\"price\"><label for=\"item_"+ebox+optionInfo[0]+"\">"+number_format(optionInfo[2])+"</label></span>\n";
				txt += helpDiv;
				txt += "</li>\n";						
			}
			else {
				var optionPrice = 0;
				
				if(Math.abs(optionInfo[2])>100){
					optionPrice = "<span class='txt'><span class='num'>"+number_format(optionInfo[2]/10000)+"</span>만 원</span>";
				}

				if (optionTypeText != optionInfo[4]) {
					
					if (optionTypeText != '') {
						txt += "</div></div>";
					}

					optionTypeText = optionInfo[4];
					
					txt += "<div class='article-box'>\
				                <div class='article-box__header'>\
				                    <h4 class='title'>"+optionTypeList[optionTypeText]+"</h4>\
				                </div>\
				                <div class='article-box__cont'>";
				}
				
				if (estmOptionRank["T"+trimCode+"O"+optionInfo[0]]) {
					optionAddInfo += "<div class='label_area'><div class='prefer_label'><span class='g-label-newtop'>TOP"+estmOptionRank["T"+trimCode+"O"+optionInfo[0]].split("`")[0]+"</span><span class='rate'>선택률: <span class='num'>"+estmOptionRank["T"+trimCode+"O"+optionInfo[0]].split("`")[1]+"%</span></span></div></div>";
				}
				
				var dependOptionClass = '';
				
				if (optionInfo[5]) {
					dependOptionClass = "dependOption_"+optionInfo[5];
				}
				
				txt += "<div class='choice-toggle choice-toggle--"+toggleOnOff+ " " + moreOnOff + "'>\
							<input id='popupItem_"+ ebox + optionInfo[0] +"' class='"+dependOptionClass+"' title='옵션d품목' name='option' value='"+ value +"' type='checkbox' data-overlap='"+ optionInfo[3] +"' code='"+ optionInfo[0] +"' "+$("#item_1"+optionInfo[0]).attr('checked')+">\
							<div class='choice-toggle__header sendGA' data-actionlabel='옵션 펼쳐보기`"+optionInfo[1]+"'>\
								<label for='popupItem_"+ ebox + optionInfo[0] +"'>"+optionInfo[1]+"</label>\
								<div class='choice__check'><span class='icon_check'></span></div>\
								<div class='choice__wrap'>\
									<div class='choice__cell choice__info'><span class='txt'>"+optionInfo[1]+"</span>"+addBtn+optionAddInfo+"</div>\
									<div class='choice__cell choice__price'>"+optionPrice+"</div>\
								</div>\
								"+toggleBtn+"\
							</div>\
							"+helpDiv+"\
			            </div>";
			}
		});
		
		if (moreBtn) {
			txt += moreBtn;
		}

		txt += "</div></div>";
	}
	else if(0 && setTrms.itms){
	}
	else {
		// 2019.01.22 blank class 삭제
		// 2019.02.28 blank class 추가(중앙정렬)
		txt += "<div class='article-box'>\
	                <div class='article-box__header'>\
	                    <h4 class='title'>선택품목이 없습니다.</h4>\
	                 </div>\
	             </div>";
		
		/*
		 * 2019.01.21 verere@danawa.com 모델비교 중 선택사양 항목이 없을 경우 테이블 깨짐 현상 해결
		 * https://jira.danawa.com/projects/AUTO/issues/AUTO-437 (http://eip.danawa.com/dg/support/work_task.nsf/view_by_my_proc_statustype/E4514832EA1CE60B49258343001074D2?opendocument&ui=webmail&readtype=popup&pcontentsid=undefined)
		 * 	해당 이슈 작업시 내용 없을 경우 display none 처리 추가
		 */
		if (gnb != 'compare') {
//			$("#eDiv_1 .tab-list li").filter(function(){if($(this).data('id') == 'Optn_1') $(this).hide()})
			$("#Optn_"+ebox + " .eChkItemList").hide();
			$("#Optn_hr_"+ebox).hide();
		}
	}
	
	if(0 && emod == 'appView') {
	}
	else {
		$("#Optn_"+ebox+" .eChkItemList").html(txt);
		
		if(emod == 'compare') {
			$(document).on("click","#compareOptionMoreBtn_" + eChkItemListCnt, function() {
				$(this).parents(".eChkItemList").children("li").show();
				$(this).hide();

				var height = 0;
				$(".compareOptionMoreBtn").each(function(index, item){
					if(index == 0) {
						height = $(this).parents("tr").height();
					}
					
					if(height < $(this).parents("tr").height()) {
						height = $(this).parents("tr").height();
					}
				});
				
				$("#leftOptn").parents("tr").height(height);
			});
		}
	}
	
	$("#Optn_"+ebox+" .btn_moreview").show();
	
	if ($("#Optn_"+ebox+" ul.eChkItemList li").length < 6) {
		$("#Optn_"+ebox+" .btn_moreview").hide();
	}
}

/* 선택사양 중복/의존 체크해주는 기능, 아래 4개의 함수 병행 사용  2014-05-12 수정(확인필요)  */
function items_check(opt,ckd)
{
	if(ebox.substring(0,1)=="P") {
		iBox = ".pChkItemList[ebox='"+ebox+"'] ";
	}
	else if(ebox.substring(0,1)=="I") {
		//iBox = ".iChkItemList[ebox='"+ebox+"'] ";
		iBox = ".iChkItemList_"+ebox;
	}
	else {
		iBox = "#Optn_"+ebox+" .eChkItemList";
	}
	
	var tmpVal = dnw_deChar($(iBox+" input[code='"+opt+"']").val()).split("`");
	var tmpVal2 = tmpVal[1].split(":");
	var optionCode = tmpVal[3];

	var tmp = "";
	
	if(tmpVal2.length > 1) {
		tmp = string_trim(tmpVal2[1]);
	}
	
	var Cstr = "";
	
	if(tmp) {	// 선택된 정보 수집..
		infoSel = "";
		infoOff = "";
		infoMy = "";
		Pckd = 0;
		Psel = 0;
		Poff = 0;
		Pstr = "";
		items_selOnoff(opt);
	}
	
	if(ckd && tmp) {	// 선택시
		infoMy = tmp;
		
		for(Cct = 0; Cct < tmp.length; Cct ++){
			Cstr = tmp.substring(Cct,Cct+1);
			
			if(Cstr.toUpperCase()==Cstr){	// 중복옵션 제거
				if(infoSel.indexOf(Cstr)>=0){
					items_selOffL(Cstr,opt);
				}
			}
			else{	// 부모선택 확인후 지정
				Pckd ++;
				
				if(infoSel.indexOf(Cstr.toUpperCase())>=0 || infoMy.indexOf(Cstr.toUpperCase())>=0){
					Psel ++;
				}
				else if(infoOff.indexOf(Cstr.toUpperCase())>=0){
					Poff ++;
					Pstr += Cstr;
				}
			}
		}
		
		if(Pckd && Psel==0 && Poff){
			for(Cct = 0; Cct < Pstr.length; Cct ++){
				Cstr = Pstr.substring(Cct,Cct+1);
				items_selOnP(Cstr,opt);
			}
		}
	}
	else if(tmp) {	// 해제시
		items_selOffC(tmp,opt);
	}
	
	
	if (optionCode) {
		setDependOption("option", optionCode);
	}
}
/* 선택사양 부모옵션 선택..  2014-05-12 수정(확인필요)  */
function items_selOnP(pmp,pxt){
	var addInfoLayer = false;
	var addInfoText = "";
	var popupPsel = Psel;
	
	$(iBox+" input").each(function(){
		Pode = $(this).attr("code");

		if(!$(this).is(":checked") && pxt.indexOf(Pode)<0 && Psel == 0){
			var pmpVal = dnw_deChar($(this).attr("value")).split("`");
			var pmpVal2 = pmpVal[1].split(":");
			
			if(pmpVal2.length > 1 && pmpVal2[1] && pmpVal2[1].indexOf(pmp.toUpperCase())>=0){
				$(this).prop("checked",true);
				$(this).parent().addClass("sel");
				
				pmpVal2[1] = pmpVal2[1].replace(pmp.toUpperCase(),"");
				Psel ++;
				
				if(pmpVal2[1]){
					for(Pct = 0; Pct < pmpVal2[1].length; Pct ++){
						Pstr = pmpVal2[1].substring(Pct,Pct+1);
						items_selOffL(Pstr,pxt+","+Pode);
					}
				}
				
				if(addInfoText == "") {
					addInfoText = pmpVal[2];
				} else {
					addInfoText += ", " + pmpVal[2];
				}
				addInfoLayer = true;
			}
		}
	});
	
	if(addInfoLayer && gnb == 'newcar') {
		openDependOptionPopup(addInfoText);
		return false;
	}
}

/* 선택사양 중복옵션 제거..  2014-05-12 수정(확인필요)  */
function items_selOffL(omp,oxt)
{
	var removeInfoLayer = false;
	var removeInfoText = "";
	
	$(iBox+" input").each(function(){
		Oode = $(this).attr("code");
		
		if($(this).is(":checked") && oxt.indexOf(Oode)<0){
			var ompVal = dnw_deChar($(this).attr("value")).split("`");
			var ompVal2 = ompVal[1].split(":");
			
			if(ompVal2.length > 1 && ompVal2[1] && ompVal2[1].indexOf(omp)>=0){
				$(this).prop("checked",false);
				$(this).parent().removeClass("sel");
				
				infoSel = infoSel.replace(ompVal2[1],"");
				ompVal2[1] = ompVal2[1].replace(omp,"");
				
				if(ompVal2[1]){
					items_selOffC(ompVal2[1],oxt);
				}
				
				if(removeInfoText == "") {
					removeInfoText = ompVal[2];
				} else {
					removeInfoText += ", " + ompVal[2];
				}
				removeInfoLayer = true;
			}
		}
	});
	
	if(removeInfoLayer && gnb == 'newcar') {
		var selectOptionName = $("label[for='popupItem_"+ ebox+oxt +"']").text();
		var contents = 	"<div class='layer__data-info'>" +
							"<b>'" + removeInfoText + "'</b> 옵션과 중복 선택 할 수 없어 제외되었습니다." +
						"</div>";
		$("#layerPopup .g-layer__cont").empty().append(contents);
		openLayerPopup('near', "중복 옵션 안내", $(this));
		return false;
	}
}
/* 선택사양 자식옵션 제거..  2014-05-12 수정(확인필요) */
function items_selOffC(dmp,dxt){
	for(Dct = 0; Dct < dmp.length; Dct ++){
		Dstr = dmp.substring(Dct,Dct+1);
		
		if(Dstr.toUpperCase()==Dstr){	// 중복옵션 제거
			if(infoMy.indexOf(Dstr)<0){
				Dstr = Dstr.toLowerCase();
				
				if(infoSel.indexOf(Dstr)>=0){
					$(iBox+" input").each(function(){
						Dode = $(this).attr("code");
						
						if($(this).is(":checked") && dxt.indexOf(Dode)<0){
							var dmpVal = dnw_deChar($(this).attr("value")).split("`");
							var dmpVal2 = dmpVal[1].split(":");
							
							if(dmpVal2.length > 1 && dmpVal2[1] && dmpVal2[1].indexOf(Dstr)>=0){
								dmpVal2[1] = dmpVal2[1].replace(Dstr,"");
								
								var CkdCt = 0;
								
								if(dmpVal2[1]){
									for(Dct2 = 0; Dct2 < dmpVal2[1].length; Dct2 ++){
										Dstr2 = dmpVal2[1].substring(Dct2,Dct2+1);
										
										if(Dstr2.toLowerCase()==Dstr2){
											if(infoSel.indexOf(Dstr2.toUpperCase())>=0 || infoMy.indexOf(Dstr2.toUpperCase())>=0){
												CkdCt ++;
											}
										}
									}
								}
								
								if(CkdCt==0){
									$(this).prop("checked",false);
									$(this).parent().removeClass("sel");
									
									infoSel = infoSel.replace(dmpVal2[1],"");
								}
							}
						}
					});
				}
			}
		}
	}
}

/* 선택사양 선택/비선택 구분.. 2014-05-12 수정(확인필요) */
function items_selOnoff(Sopt)
{
	$(iBox+" input").each(function(){
		code = $(this).attr("code");
		
		if(Sopt!=code){
			var cmpVal = dnw_deChar($(this).val()).split("`");
			var cmpVal2 = cmpVal[1].split(":");
			
			if(cmpVal2.length > 1 && cmpVal2[1]){
				var cmp = string_trim(cmpVal2[1]);
				
				if($(this).is(":checked")){
					infoSel += cmp;
				}
				else{
					infoOff += cmp;
				}
			}
		}
	});
}

/* 면세 변수 */
//0 구분, 1 가격과세, 2 지방세과세, 3 업무용(3)
function tfree_value(cod)
{
	var str = '';
	
	if (cod == 'PG') str = 'G111'; // 일반인(비면세)
	else if(cod == 'PC') str = 'G141'; // 다자녀 감면</option>
	else if(cod == 'H1') str = 'H000'; // 장애등급 1~3급</option>
	else if(cod == 'H3') str = 'L100'; // 시각장애 4급</option>
	else if(cod == 'H4') str = 'L110'; // 일반장애 4급</option>
	else if(cod == 'H5') str = 'L110'; // 일반장애 5~6급</option>
	else if(cod == 'HN') str = 'H000'; // 국가유공장애</option>
	else if(cod == 'HG') str = 'H000'; // 광주민주관련장애</option>
	else if(cod == 'HV') str = 'H000'; // 고엽제후유장애</option>
	else if(cod == 'CT') str = 'T023'; // 사업용(택시대차)</option>
	else if(cod == 'CG') str = 'C033'; // 사업용(렌터카/기타)</option>
	else str = 'G111';
	
	setFree['grup'] = str.substring(0,1);
	setFree['pric'] = str.substring(1,2);
	setFree['enty'] = str.substring(2,3);
	setFree['clas'] = str.substring(3,4);
}

/* 개별소비세 감면 계산 오픈 후 수입차에도 장애인 면세 가격 입력된다면 일반용도 수정해야 함.. */
//2018.04.23 verere@danawa.com 연료전지 개소세 추가, 전기 개소세 변경
/**
 * 
 * @param vol 기본가격
 * @param rat 개소세+교육세 비율
 * @param kid 연료 할인 종류
 * @returns cal = 개소세 감면 급액
 */
function tfree_cost (vol, rat, kid)
{
	var taxFreeCost = 0;
	var isDiscount = 0;
	
	if ( setTrms.name.indexOf('개별소비세 인하') != -1 && setTrms.ctax == 5.0 && setTrms.code.substr(0, 3) < 340 ) {
		isDiscount = 1;
		hasSpecialConsumptionTaxDiscounted = 1;
	}
	/*else if ( setTrms.name.indexOf('개별소비세 3.5% 적용') != -1 && setTrms.ctax != 5.0 && setTrms.code.substr(0, 3) < 340 ) {
		hasSpecialConsumptionTaxDiscounted = 1;
	}*/
	
	$.ajax({
		url: apiUrl + '/v1/S/tax/taxCutPrice/?basePriceType=sellingPrice&price='+ vol +'&reductionType='+ kid +'&code='+ setTrms.code.substr(0, 3) + '&customSpecialConsumptionTax=' + rat + '&isDiscount=' + isDiscount,
		type: 'GET',
		dataType: 'json',
		async: false,
		error: function() {},
		success: function(data) {
			taxFreeCost = data.taxCutPrice * -1;
		}
	});
	
	return taxFreeCost;
}

/* 판매조건 목록 표시 2014-05-11 추가 완료 */
//2019.02.11 mjmjmjmj91@danawa.com 국내차/수입차 구분해서 판매조건 리스트 생성
function terms_list(use){
	///var ebox = estmAct;
	var txt = '';
	var txtSingle = '';
	
	if(use){
		if(valCode.brnd < 340) {
			for(key in setTermM){
				if(setTermB[key]){	// 데이터 없는 것 표시되는 것 있음.. 판매조건 코드 매칭후 제거 방법 검토해야 함..
					var nam = setTermB[key].split("`");
					var tmp = setTermM[key].split("\n");
					var strH = "";
					var strS = "";
					var toggleOnOff = 'close';
					
					ctB = 0;
					ctY = 0;
					
					if(emod == 'compare') {	
						if(nam[6]!="0") addBtn = "<button type=\"button\" class=\"helpView buttonHelp\" no=\""+nam[6]+"\" kind=\"termInfo\" subject=\"판매조건\"><span class=\"screen_behind\">보기</span></button>";
						else addBtn = "";
						
						strH = "<li code=\""+key+"\" class=\"ttl\"><span class=\"title\">"+nam[5]+addBtn+"</span></li>";
						
						if(nam[7]=="1" || nam[7]=="2"){
							for(key2 in tmp){
								if(tmp[key2].indexOf("F")!=0){	// 할부조건 표시하지 않음
									var tmp2 = tmp[key2].split("`");
									var Tval = tmp2[0]+"`"+nam[5];
									
									if(tmp2[1] && cost>0 && cost<100) Tval += "("+tmp2[1]+" "+cost+"%)";
									else if(tmp2[1]) Tval += "("+tmp2[1]+")";
									else tmp2[1] = "";
									
									var pric = '';
									var perR = '';
									
									//var cost = number_only(tmp2[0]);
									var cost = tmp2[0].replace('F', '');
									var costPrice = '';
									
									//금액화  퍼센트와 같이 들어올경우
									if(cost.indexOf('+') > -1) {
										costPrice = cost.split('+');
										
										$.each(costPrice, function(i,v){
											v.trim();
											
											if(i == 1) {
												pric += ' + ';
											}
											
											if(Math.abs(v)>100) {
												pric += v;
											}
											else if(v>0 && v<100) {
												pric += v+"%";
											}
	
										});
									}
									//단일로 왔을경우
									else {
										if(Math.abs(cost)>100){
											pric = number_format(cost);
										}
										else if(cost){
											pric = " <span class=\"eRsltTermPers\" code=\""+key+ctB+"\"></span>";
											perR = "("+cost+"%)";
										}									
									}
									
									if(tmp2[0]=="C"){
										strS += "<li class=\"cmt\">\n";
										strS += "<span class=\"comnt\">※ "+tmp2[1]+"</span>\n";
										strS += "</li>\n";
									}
									else{
										// 판매조건 쉽표 줄바꿈 적용, 괄호 앞 띄어쓰기 하면 └ 표시 추가 :  2015-10-14
										var tmpName = "";
										
										tmpName = tmp2[1].replace(/, /gi,",<br />");
										tmpName = tmpName.replace(/ \(/gi,"<br />└ (");
										
										strS += "<li code=\""+key+ctB+"\" class=\"sub\">\n";
										strS += "<input type=\"checkbox\" value=\""+dnw_enChar(Tval)+"\" code=\""+key+ctB+"\" id=\"term_"+ebox+key+ctB+"\" />\n";
										strS += "<span class=\"title\"><label for=\"term_"+ebox+key+ctB+"\">"+tmpName+perR+"</label></span>\n";
										strS += "<span class=\"price\"><label for=\"term_"+ebox+key+ctB+"\">"+pric+"</label></span>\n";
										strS += "</li>\n";
									}
									
									ctY ++;
								}
								
								ctB ++;
							}
							
							if(ctY==1 && !tmp2[1]){
								txt += "<li code=\""+key+"0\" class=\"slf\">\n";
								txt += "<input type=\"checkbox\" value=\""+dnw_enChar(Tval)+"\" code=\""+key+"0\" id=\"term_"+ebox+key+"0\" />\n";
								txt += "<span class=\"title\"><label for=\"term_"+ebox+key+"0\">"+nam[5]+perR+"</label>"+addBtn+"</span>\n";
								txt += "<span class=\"price\"><label for=\"term_"+ebox+key+"0\">"+pric+"</label></span>\n";
								txt += "</li>\n";
							}
							else if(ctY){
								txt += strH;
								txt += strS;
							}
						}
					}
					else {
						
						addBtn = "";
						toggleBtn = "";
						helpDiv = "";
						
						if (nam[6] != "0") {
							addBtn = "<a href='javascript:void(0)' class='sendGA g-btn__info eFincPopup' kind='termInfo' val="+nam[6]+" data-actionlabel='할인 상세정보`"+valCode.trms+"'>상세정보 보기</a>";
							
							toggleBtn = "<div class='choice-toggle__btn'><a href='javascript:void(0)' class='btn-toggle "+toggleOnOff+" eFincPopup sendGA' data-actionlabel='할인 조건 펼쳐보기`"+ nam[5] + perR +"' kind='termPopupExp' val="+nam[6]+" data-id="+ ebox + key +"0><span class='blind'>접기</span></a></div>";
							
							helpDiv = "<div class='choice-toggle__cont'>\
											<div class='infodetail__cont'>\
											    <p class='exp' id='popupTermExp_"+ebox + key+"0'></p>\
											</div>\
											<div class='infodetail__btn'>\
										    	<label for='term_"+ ebox + key +"0' class='btn-check btn-check--sale sendGA' data-actionlabel='할인 조건 펼쳐보기 내 선택`"+ nam[5] + perR +"'></label>\
											</div>\
										    <div class='choice-toggle__close mobOnly'>\
												<a href='javascript:void(0)' class='btn-toggle-close sendGA' data-actionlabel='할인 조건 펼쳐보기 내 선택`영역 닫기'><span class='txt'>닫기</span></a>\
											</div>\
										</div>"
						}

						strH = "<div class='article-box__header' code='"+ key +"'>\
				                    <h4 class='title'>"+nam[5]+"</h4>\
				                    "+addBtn+"\
				                </div>";
						
						if(nam[7]=="1" || nam[7]=="2"){
							
							for(key2 in tmp){
								
								// 할부조건 표시하지 않음
								if(tmp[key2].indexOf("F")!=0){
									
									var tmp2 = tmp[key2].split("`");
									var Tval = tmp2[0]+"`"+nam[5];
									var pric = '';
									var perR = '';

									var cost = tmp2[0].replace('F', '');		
									var costPrice = '';
									
									if(tmp2[1] && cost>0 && cost<100) {
										Tval += "("+tmp2[1]+" "+cost+"%)";
									}
									else if (tmp2[1]) {
										Tval += "("+tmp2[1]+")";
									}
									else {
										tmp2[1] = "";
									}

									//금액화  퍼센트와 같이 들어올경우
									if(cost.indexOf('+') > -1) {
										costPrice = cost.split('+');
										
										$.each(costPrice, function(i,v){
											v.trim();
											
											if(i == 1) {
												pric += ' + ';
											}
											
											if(Math.abs(v)>100) {
												pric += v;
											}
											else if(v>0 && v<100) {
												pric += v+"%";
											}
	
										});
									}
									//단일로 왔을경우
									else {
										if(Math.abs(cost)>100){
											pric = number_format(cost/10000);
										}
										else if(cost){
											pric = "-<span class='num eRsltTermPers' code=\""+key+ctB+"\"></span>만 원";
											
											if(cost != 0 ) {
												perR = "("+cost+"%)";
											}
										}									
									}
									
									if(tmp2[0]=="C"){
										strS += "<li class=\"cmt\">\n";
										strS += "<span class=\"comnt\">※ "+tmp2[1]+"</span>\n";
										strS += "</li>\n";
									}
									else{
										// 판매조건 쉽표 줄바꿈 적용, 괄호 앞 띄어쓰기 하면 └ 표시 추가 :  2015-10-14
										var tmpName = "";
										
										tmpName = tmp2[1].replace(/, /gi,",<br />");
										tmpName = tmpName.replace(/ \(/gi,"<br />└ (");
										
										var pricText = "";
										var pricNumber = pric.replace(',', '');
										
										if (pricNumber > 0) {
											pricText = "-<span class='num'>"+pric+"</span>만 원";
										}
										else {
											pricText = pric;
										}

										strS += "<div class='choice' code='"+ key + ctB +"'>\
							                        <input type='checkbox' name='option' id='term_"+ ebox+key+ctB +"' code='"+ key + ctB +"' value='"+ dnw_enChar(Tval) +"'>\
							                        <label for='term_"+ ebox+key+ctB +"'>2구매</label>\
							                        <div class='choice__check'><span class='icon_check'></span></div>\
							                        <div class='choice__wrap'>\
							                            <div class='choice__cell choice__info'><span class='txt'>"+tmpName + perR+"</span></div>\
							                            <div class='choice__cell choice__price'><span class='txt'>"+pricText+"</span></div>\
							                        </div>\
							                    </div>";
									}
									
									ctY ++;
								}
								
								ctB ++;
							}
							
							if(ctY==1 && !tmp2[1]){
								
								var pricText = "";
								
								if (pric > 0) {
									pricText = "-<span class='num'>"+pric+"</span>만 원";
								}

								txtSingle += "<div class='choice-toggle choice-toggle--"+toggleOnOff+" choice' code='"+ key +"0'>\
										        <input type='checkbox' name='option' id='term_"+ ebox+key +"0' code='"+ key +"0' value='"+ dnw_enChar(Tval) +"'>\
										        <div class='choice-toggle__header'>\
										            <label for='term_"+ ebox+key +"0'>"+ nam[5] + perR +"</label>\
										            <div class='choice__check'><span class='icon_check'></span></div>\
										            <div class='choice__wrap'>\
										                <div class='choice__cell choice__info'><span class='subtxt'></span><span class='txt'>"+ nam[5] + perR +"</span></div>\
										                <div class='choice__cell choice__price'><span class='txt'><span class='num'>"+pricText+"</div>\
										            </div>\
									               "+toggleBtn+"\
										        </div>\
								               "+helpDiv+"\
										    </div>";
							}
							else if(ctY){
								
								txt += "<div class='article-box'>"+strH;

								if (strS) {
									txt += "<div class='article-box__cont'>\
												"+strS+"\
											</div>";
								}
								
								txt += "</div>";
							}
						}
					}
				}
			}
			
			if (txtSingle != '') {
				txtSingle = "<div class='article-box article-box--single'>\
								<div class='article-box__header'>\
									<h4 class='title'>기타 할인</h4>\
								</div>\
								<div class='article-box__cont'>\
									"+txtSingle+"\
								</div>\
							</div>";
				
				txt += txtSingle;
			}
		}
	}

	// 수입차 판매조건 노출
	if(valCode.brnd >= 340) {
		
		if (estmDataTermImport["T"+valCode.trms]) {
			
			var tmp = estmDataTermImport["T"+valCode.trms].split("`");
			var financeText = cashText = priceOnOff = '';
			
			if (tmp[2] || tmp[4]) {
				if (tmp[4]) {
					financeText = "<div class='choice__row'>\
				                        <div class='choice__cell choice__info'><span class='txt'> 추가혜택</span></div>\
				                        <div class='choice__cell choice__price'><span class='txt'>"+tmp[4]+"</span></div>\
				                    </div>";
				}
				
				if (tmp[2] == 0) {
					priceOnOff = 'off';
				} else {
					priceOnOff = '';
				}
				
				financeText = "<div class='choice' code='"+ valCode.trms +"F' >\
					                <input type='radio' value='"+ tmp[2] +"`" + texts.brand + " 파이낸스 이용 시 할인' code='"+ valCode.trms +"F' id='term_1"+ valCode.trms +"F' name='term_temp_1' checked>\
					                <label for='term_1"+ valCode.trms +"F'>" + texts.brand + "파이낸스 이용 시 할인</label>\
					                <div class='choice__check'><span class='icon_check'></span></div>\
					                <div class='choice__wrap'>\
					                    <div class='choice__cell choice__info'><span class='txt'>" + texts.brand + " 파이낸스 이용 시 할인</span><a href='javascript:void(0)' class='g-btn__help eFincPopup' kind='dictionary' val='470'>도움말</a></div>\
					                    <div class='choice__cell choice__price'><span class='txt "+priceOnOff+"'><span class='num'>-"+(number_format(tmp[2]/10000))+"</span>만 원</span></div>\
					                    "+financeText+"\
					                </div>\
					            </div>";
			}
			
			if (tmp[1] || tmp[3]) {
				
				if (tmp[3]) {
					cashText = "<div class='choice__row'>\
									<div class='choice__cell choice__info'><span class='txt'> 추가혜택</span></div>\
									<div class='choice__cell choice__price'><span class='txt'>"+tmp[3]+"</span></div>\
								</div>";
				}
				
				if (tmp[1] == 0) {
					priceOnOff = 'off';
				} else {
					priceOnOff = '';
				}
				
				cashText = "<div class='choice' code='"+ valCode.trms +"C'>\
				                <input type='radio' value='"+ tmp[1] +"`현금/타금융 이용 시 할인' code='"+ valCode.trms +"C' id='term_1"+ valCode.trms +"C' name='term_temp_1'>\
				                <label for='term_1"+ valCode.trms +"C'>현금/타금융 이용 시 할인</label>\
				                <div class='choice__check'><span class='icon_check'></span></div>\
				                <div class='choice__wrap'>\
				                    <div class='choice__cell choice__info'><span class='txt'>현금/타금융 이용 시 할인</span><a href='javascript:void(0)' class='g-btn__help eFincPopup' kind='dictionary' val='471'>도움말</a></div>\
				                    <div class='choice__cell choice__price'><span class='txt "+priceOnOff+"'><span class='num'>-"+(number_format(tmp[1]/10000))+"</span>만 원</span></div>\
				                    "+cashText+"\
				                </div>\
				            </div>";
			}		
	
			if (financeText || cashText) {
				txt += "<div class='estimate__cont'>\
				    <div class='article-box'>\
				        <div class='article-box__cont'>\
		                    "+financeText+"\
		                    "+cashText+"\
				        </div>\
				    </div>\
				</div>";
			}
		}
	}
	
	if (txt == ""){
   
		txt += "<div class='estimate__cont'>\
					<div class='article-box'>\
						<div class='estimate__blank'>할인 조건 준비 중입니다.</div>\
					</div>\
			    </div>";			
	}

	$("#Term_"+ebox+" .eChkTermList").html(txt);
	
	$("#Term_"+ebox+" .btn_moreview").show();
	
	if ($("#Term_"+ebox+" ul.eChkItemList li").length < 6) {
		$("#Term_"+ebox+" .btn_moreview").hide();
	}
}

/* 판매조건 적용 여부 판단 2015-03-01 적용 */
function terms_ox(tem){
	var tExpL = "";
	var tExpT = "";
	
	if(typeof(estmDataTerm["L"+valCode.line])!="undefined" && estmDataTerm["L"+valCode.line]!="none"){
		tExpL += dnw_deChar2(estmDataTerm["L"+valCode.line])+",";
	}
	
	if(typeof(estmDataTerm["T"+valCode.trms])!="undefined" && estmDataTerm["T"+valCode.trms]!="none"){
		tExpT += dnw_deChar2(estmDataTerm["T"+valCode.trms])+",";
	}

	var tOX = true;
	
	// 라인업 판단..
	if(tOX && tExpL && tExpL.indexOf(tem.substr(0,3)+"X")>=0 && $.inArray(tem, tExpL.split(",")) == -1){
		tOX = false;
	}
	else if(tOX && tExpL && tExpL.indexOf(tem.substr(0,3))>=0 && $.inArray(tem, tExpL.split(",")) == -1){
		tOX = false;
	}

	// 트림 판단..
	if(tOX && tExpT && tExpT.indexOf(tem.substr(0,3)+"X")>=0 && $.inArray(tem, tExpT.split(",")) == -1){
		tOX = false;
	}
	else if(tOX && tExpT && tExpT.indexOf(tem.substr(0,3))>=0 && $.inArray(tem, tExpT.split(",")) == -1){
		tOX = false;
	}

	return tOX;
}

/* 판매조건 제외항목 처리 2014-05-12 수정 완료 */
function terms_disabled(){
	if(!mobile) {
		$("#Term_"+ebox).show();
	}
	$("#Term_"+ebox+" .eChkTermList input").prop("disabled",false);
	$("#Term_"+ebox+" .eChkTermList .choice").removeClass("not").show();
	
	var hasTermList = false;

	$("#Term_"+ebox+" .eChkTermList input").each(function(){
		var code = $(this).attr("code");
		var codX = code.substring(0,3)+"X";
		
		if(terms_ox(code) == false){// tExp.indexOf(code)>=0 || tExp.indexOf(codX)>=0	terms_ox(code) == false
			$(this).prop("disabled", true);
			$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").addClass("not");
			$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").removeClass("sel");
			$("#Term_"+ebox+" .eChkTermList .choice[code='"+code.substring(0,3)+"']").removeClass("sel");
			
			$(this).closest('.choice').hide();
		}
		else{
			$(this).removeAttr("disabled");
			$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").removeClass("not");
			
			hasTermList = true;
			$(this).closest('.choice').show();
		}
	});

	// 판매조건 비활성 그룹 숨김처리
	$("#Term_"+ebox+" .eChkTermList .article-box__header").each(function(){
		var groupCode = $(this).attr("code")

		if (groupCode && $("#Term_"+ebox+" .eChkTermList input[code^='"+groupCode+"']").not(":disabled").length == 0) {
			$(this).closest(".article-box").hide();
		}
		else {
			$(this).closest(".article-box").show();
			
			if (typeof(groupCode) == 'undefined' && $(this).parent().find("input[id^='term_1']:disabled").length > 0) {
				$(this).closest(".article-box").hide();
			}
		}
	});
	
	/* 2019.02.01 mjmjmjmj91@danawa.com 수입차는 판매조건영역 무조건 노출 */
	if (!hasTermList && valCode.brnd < 340) {
		/*
		 * 2019.01.21 verere@danawa.com 모델비교 중 선택사양 항목이 없을 경우 테이블 깨짐 현상 해결
		 * AUTO-437 (http://eip.danawa.com/dg/support/work_task.nsf/view_by_my_proc_statustype/E4514832EA1CE60B49258343001074D2?opendocument&ui=webmail&readtype=popup&pcontentsid=undefined)
		 * 해당 이슈 작업시 내용 없을 경우 display none 처리 추가
		 */

		if (gnb != 'compare') {
			//$("#Term_"+ebox).hide();
			//$("#Term_hr_"+ebox).hide();
		}
	}

}
/* 판매조건 기본적용 자동 선택 2014-05-12 수정 완료 */
function terms_auto(){
	//var ebox = estmAct;
	var ckdCode = ",";
	
	// 선택되어 있는 기본조건 확인
	$("#Term_"+ebox+" .eChkTermList input").each(function(){
		if(typeof($(this).attr("disabled"))=="undefined"){
			if($(this).is(":checked")){
				ckdCode += $(this).attr("code")+",";
			}
		}
	});
	
	$("#Term_"+ebox+" .eChkTermList input").each(function(){
		if(typeof($(this).attr("disabled"))=="undefined"){
			var code = $(this).attr("code");
			var cod = code.substring(0,3);
			var codG = code.substring(0,1);
			var codX = code.substring(1,3);
			var tempConf = tmp = '';
			
			if(codG == "B" || codG == "E"){
				if(ckdCode.indexOf(cod)<0){					
					//선택된 판매조건이 없을경우 B10을 기본 체크로 설정
					if (typeof(rsltConf[ebox]) != "undefined" && rsltConf[ebox].length) {
						tmpConf = rsltConf[ebox].split("@");
						
						if (tmpConf.length > 1) {
							tmp = tmpConf[1].split(",");
						}
					}

					if((tmp.length == 0 || tmp[0] == "") && ($(".eChkTermList .choice[code='B100']").length > 0 && cod == 'B10') || $(".eChkTermList .choice[code='B100']").length  == 0) {
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+code.substring(0,3)+"']").find('div').addClass("checked");
						$(this).prop("checked",true);
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").addClass("sel");
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+cod+"']").addClass("sel");						
						terms_check(code);
					} else if($(".eChkTermList .choice[code^='B1']").length > 0) {
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+code.substring(0,3)+"']").find('div').addClass("checked");
						$(this).prop("checked",true);
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").addClass("sel");
						$("#Term_"+ebox+" .eChkTermList .choice[code='"+cod+"']").addClass("sel");						
						terms_check(code);
					}		 			
					
					ckdCode += code+",";
				}
			}
			else if(codG == "S"){	// 재고조건 초기화..
				$(this).prop("checked",false);
				$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").removeClass("sel");
				$("#Term_"+ebox+" .eChkTermList .choice[code='"+cod+"']").removeClass("sel");
			}
			else if(codX == "XX"){	// 최대할인조건 초기화..
				$(this).prop("checked",false);
				$("#Term_"+ebox+" .eChkTermList .choice[code='"+code+"']").removeClass("sel");
				$("#Term_"+ebox+" .eChkTermList .choice[code='"+cod+"']").removeClass("sel");
			}
		}
		else{	// disabled
			$(this).prop("checked",false);
		}
	});
}
/* 판매조건 선택시 중복 동일 체크 2014-05-13 수정 완료 */
function terms_check(tem){

	if (valCode.brnd < 340) {
		var term = tem.substring(0,3);
		
		$("#Term_"+ebox+" .eChkTermList .choice input[code^='"+term+"']").each(function(){	// 동일항목 선택 확인
			var termC = $(this).attr("code");
			
			if(termC!=tem){
				$(this).prop("checked",false);
			}
		});
		
		var temVal = setTermB[term].split("`");
		
		if(temVal[2]){ // 중복되는 조건 제거..
			tmp = temVal[2];
			
			for(Cct = 0; Cct < tmp.length; Cct ++){
				Cstr = tmp.substring(Cct,Cct+1);
				
				$("#Term_"+ebox+" .eChkTermList .choice input:checked").each(function(){	// 동일항목 선택 확인
					var termC = $(this).attr("code");

					if(termC!=tem){
						var temVal2 = setTermB[termC.substring(0,3)].split("`");
						
						if(temVal2[2] && temVal2[2].indexOf(Cstr)>=0){
							$("#Term_"+ebox+" .eChkTermList .choice[code='"+termC.substring(0,3)+"'] input").prop('checked', false)
							$(this).prop("checked",false);
						}
					}
				});
			}
		}
	}
}

/* 판매조건 기존 선택 반영 미사용? */
function terms_reset()
{
	tmp = codes.term.split(",");
	for(Cct = 0; Cct < tmp.length; Cct ++){
		if(tmp[Cct].substr(0,1)=="X"){
			$("#CKTERMSQ"+ebox+"J"+tmp[Cct]).prop("checked",true);
		}
		else{
			$("#CKTERMQ"+ebox+"J"+tmp[Cct]).prop("checked",true);
			$("#CKTERMQ"+ebox+"J"+tmp[Cct]).parent().addClass("EtermSel");
			$("#CKTERMQ"+ebox+"J"+tmp[Cct]).parent().parent().addClass("EtermSel");
		}
	}
}

/* 미사용? */
function terms_checkSelf(kd,part)
{
	txt = $("#IPTERMSTQ"+ebox+"J"+part).val();
	
	if(txt == "조건 명칭 입력") txt = "";
	
	vol = number_only($("#IPTERMSVQ"+ebox+"J"+part).val());
	
	if(kd!="S" && vol && part.substring(1,2)=="P"){
		calculate("term",part);
	}
	else if(vol && txt){
		calculate("term",part);
	}
	else if(kd=="S" || $("#CKTERMSQ"+ebox+"J"+part).is(":checked")){
		alert("조건 명칭과 금액을 모두 입력하세요.")
		$("#CKTERMSQ"+ebox+"J"+part).prop("checked",false);
	}
	
	if(txt == "") $("#IPTERMSTQ"+ebox+"J"+part).val("조건 명칭 입력");
	
	if(vol == ""){
		$("#IPTERMSVQ"+ebox+"J"+part).val(0);
		
		if(part.substring(1,2)=="P") $("#SPTERMSVQ"+ebox+"J"+part).text(0);
	}
	else if(part.substring(1,2)!="P"){
		$("#IPTERMSVQ"+ebox+"J"+part).val(number_format(vol));
	}
}

function taxChangedPrice(tax,price)
{
	tax = parseFloat(tax);
	price = parseInt(price);
	
	var price2 = 0;
	var gap = 0;
	
	if(tax == 5.0){
		taxB = 3.5;
		price2 = price * (1 + taxB * 1.3 / 100) / (1 + tax * 1.3 / 100 );
		price2 = number_round(price2,10000,'round');
		gap = price2 - price;
	}
	else if(tax == 3.5){
		taxB = 5.0;
		price2 = price * (1 + taxB * 1.3 / 100) / (1 + tax * 1.3 / 100 );
		price2 = number_round(price2,10000,'round');
		gap = price2 - price;
	}
	
	return gap;
}

function EVIncentiveInfo() {
	var nEVGovPrice = nEVLocPrice = nEVLocRemainCount = 0;
	
	// ajax를 통한 정부보조금 조회
	$.ajax({
		url: webUrl + '/service/ajax_estimate_action.php',
		type: 'POST',
		dataType: 'json',
		data:{
			Wjob: 'getEVGovIncnt',
			No: valCode.trms,
			Option: codes.itms
		},
		async: false,
		error: function() {},
		success: function(data) {
			if (data.rslt) {
				if (data.govincnt != '') {
					nEVGovPrice = data.govincnt;
				}
			}
		}
	});
	
	if(nEVGovPrice > 0) {
		infos.incntGov = nEVGovPrice*-10000;
	}
	
	// 지역보조금
	nEVLocPrice = $("#Incnt_"+ebox+" #EVSigunguSelect option:selected").data("price");
	// 잔여대수
	nEVLocRemainCount = $("#Incnt_"+ebox+" #EVSigunguSelect option:selected").data("remaincount");
	
	if(nEVLocPrice > 0 && nEVLocRemainCount > 0) {
		infos.incntLoc = nEVLocPrice*-10000;
	}
	
	if($("#Incnt_"+ebox+" #EVSidoSelect option:selected").index() > 0 || $("#Incnt_"+ebox+" #EVSigunguSelect option:selected").index() > 0) {
		infos.incntZone = $("#Incnt_"+ebox+" #EVSidoSelect option:selected").text()+"`"+$("#Incnt_"+ebox+" #EVSigunguSelect option:selected").text().split(' ')[0];
	}
}
